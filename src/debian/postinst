#!/bin/bash

set -e

SCHEDULER_SCRIPT="/usr/share/files-backup/files-backup-scheduler"
CONFIG="/etc/files-backup/_schedule.cfg"

case "$1" in
    configure)
        # Add the cronjobs to the current user's crontab if not already present
        if ! crontab -l | grep -q "# Daily Backup - $SCHEDULER_SCRIPT"; then
            (crontab -l 2>/dev/null || true; echo "0 2 * * * $SCHEDULER_SCRIPT -r daily -c $CONFIG # Daily Backup - DO NOT EDIT THIS ENTRY MANUALLY!") | crontab -
        else
            echo "Daily cronjob already exists. Skipping addition."
        fi

        if ! crontab -l | grep -q "# Weekly Backup - $SCHEDULER_SCRIPT"; then
            (crontab -l 2>/dev/null || true; echo "0 3 * * 0 $SCHEDULER_SCRIPT -r weekly -c $CONFIG # Weekly Backup - DO NOT EDIT THIS ENTRY MANUALLY!") | crontab -
        else
            echo "Weekly cronjob already exists. Skipping addition."
        fi

        if ! crontab -l | grep -q "# Monthly Backup - $SCHEDULER_SCRIPT"; then
            (crontab -l 2>/dev/null || true; echo "0 4 1 * * $SCHEDULER_SCRIPT -r monthly -c $CONFIG # Monthly Backup - DO NOT EDIT THIS ENTRY MANUALLY!") | crontab -
        else
            echo "Monthly cronjob already exists. Skipping addition."
        fi

        if ! crontab -l | grep -q "# Yearly Backup - $SCHEDULER_SCRIPT"; then
            (crontab -l 2>/dev/null || true; echo "0 5 1 1 * $SCHEDULER_SCRIPT -r yearly -c $CONFIG # Yearly Backup - DO NOT EDIT THIS ENTRY MANUALLY!") | crontab -
        else
            echo "Yearly cronjob already exists. Skipping addition."
        fi
        ;;
    *)
        # Do nothing on other actions
        exit 0
        ;;
esac

exit 0
